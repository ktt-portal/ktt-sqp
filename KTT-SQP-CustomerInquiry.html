<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer Inquiry - Kleen-Tex Thailand</title>
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #667eea;
      --primary-dark: #764ba2;
      --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --border: rgba(255,255,255,0.2);
      --field-bg: #f8fafc;
      --field-border: #e2e8f0;
      --focus: #667eea;
      --danger: #ef4444;
      --shadow: 0 4px 14px rgba(15,23,42,.08);
      --radius: 12px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      padding: 1.5rem 2rem;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Main Container */
    .container {
      max-width: 980px;
      margin: 0 auto;
      padding: 2rem 1rem;
      flex: 1;
    }

    /* Page Title */
    .page-title {
      text-align: center;
      margin-bottom: 2rem;
      color: white;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .page-title h1 {
      font-size: clamp(24px, 4vw, 32px);
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    .page-sub {
      color: rgba(255,255,255,0.9);
      font-size: 1rem;
    }

    /* Card */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
      overflow: hidden;
      animation: fadeInUp 0.5s ease forwards;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .card .header {
      padding: 1rem 1.5rem;
      font-weight: 600;
      color: var(--primary);
      border-bottom: 1px solid var(--field-border);
      background: #f9fbfe;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .card .body {
      padding: 1.5rem;
    }

    /* Grid */
    .grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(12, 1fr);
    }
    .col-12 { grid-column: span 12; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    .col-3 { grid-column: span 4; }

    @media (max-width: 768px) {
      .col-6, .col-4, .col-3 { grid-column: span 12; }
    }

    /* Form Elements */
    label {
      display: block;
      font-size: 0.875rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    input[type="text"], input[type="email"], input[type="tel"], input[type="number"], select, textarea {
      width: 100%;
      padding: 0.75rem;
      border-radius: 8px;
      background: var(--field-bg);
      border: 1px solid var(--field-border);
      color: var(--text);
      outline: none;
      transition: all 0.2s ease;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--focus);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
      background: #fff;
    }
    textarea {
      min-height: 84px;
      resize: vertical;
    }

    /* Buttons */
    .btn {
      appearance: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      border: 1px solid var(--field-border);
      background: #eef5ff;
      color: var(--primary);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .btn.primary {
      background: var(--primary);
      color: #fff;
      border-color: transparent;
    }
    .btn.primary:hover {
      background: var(--primary-dark);
    }
    .btn.link {
      background: transparent;
      border-color: transparent;
      color: var(--danger);
    }

    /* Product Items */
    .product-item {
      border: 1px solid var(--field-border);
      border-radius: 8px;
      padding: 1rem;
      background: #fbfdff;
      position: relative;
      margin-bottom: 1rem;
    }
    .product-grid {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 1rem;
    }
    .preview-box {
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px dashed var(--field-border);
      border-radius: 8px;
      background: #f6faff;
      min-height: 120px;
      color: #9aa6b2;
    }
    .preview-box img {
      max-width: 100%;
      max-height: 160px;
      border-radius: 6px;
      display: block;
    }
    .row-line {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 0.75rem;
      margin-top: 0.75rem;
    }
    @media (max-width: 768px) {
      .product-grid { grid-template-columns: 1fr; }
      .row-line { grid-template-columns: 1fr; }
    }
    .remove-wrap {
      position: absolute;
      right: 8px;
      top: 8px;
    }

    /* Footer */
    .footer {
      display: flex;
      justify-content: flex-end;
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--field-border);
    }

    /* Error Box */
    .error-box {
      color: #b91c1c;
      background: #fff1f2;
      border: 1px solid #fecdd3;
      padding: 0.75rem;
      border-radius: 8px;
      margin-top: 1rem;
    }

    /* Debug */
    details.debug {
      margin-top: 1rem;
    }
    details.debug pre {
      background: #0b1020;
      color: #e5e7eb;
      padding: 1rem;
      border-radius: 8px;
      overflow: auto;
      font-size: 0.75rem;
    }

    /* Icon */
    .icon {
      width: 16px;
      height: 16px;
      vertical-align: middle;
    }
    .btn-home {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  margin-bottom: 20px;
  background: rgba(255, 255, 255, 0.9);
  color: #667eea;
  text-decoration: none;
  border-radius: 8px;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.btn-home:hover {
  transform: translateX(-4px);
  box-shadow: 0 4px 14px rgba(0,0,0,0.15);
  background: white;
}
.btn-floating-home {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1000;
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 50%;
  text-decoration: none;
  box-shadow: 0 4px 14px rgba(0,0,0,0.2);
  transition: all 0.3s ease;
  font-size: 1.2rem;
}

.btn-floating-home:hover {
  transform: scale(1.1) translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
}
  </style>
</head>

<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <i class="fas fa-users"></i>
        <span>Kleen-Tex Thailand - Customer Inquiry</span>
      </div>
    </div>
  </header>
 <!-- Add this anywhere in your <body> -->
  <a href="https://b753d5ef970d43bba6c1af777e54d2.6a.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/d38ff4fb38ff430681a763302b629acf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=qUQKHRRKLfmJLLkARHFlH8RPOYMt4o8zhoBTX2hxcfw" class="btn-floating-home" title="Back to Dashboard">
    <i class="fas fa-home"></i>
  </a>
  <div class="container">
    <div class="page-title">
      <h1>Customer Inquiry Form</h1>
      <div class="page-sub">Please fill out the form below</div>
    </div>
     
    <form id="inquiryForm" novalidate>
      
      <!-- Customer Contact -->
      <div class="card">
        <div class="header">
          <i class="fas fa-address-card"></i>
          Customer Contact
        </div>
        <div class="body">
          <div class="grid">
            <div class="col-6">
              <label for="company">Company Name</label>
              <input id="company" type="text" placeholder="Your Company LLC" required>
            </div>
            <div class="col-6">
              <label for="requestDate">Request Date</label>
              <input id="requestDate" type="text" inputmode="numeric" placeholder="dd/mm/yyyy" required>
            </div>
            <div class="col-6">
              <label for="contactPerson">Contact Person</label>
              <input id="contactPerson" type="text" placeholder="John Doe" required>
            </div>
            <div class="col-6">
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="john.doe@example.com" required>
            </div>
            <div class="col-6">
              <label for="phone">Phone</label>
              <input id="phone" type="tel" placeholder="+66 8x xxx xxxx" required>
            </div>
            <div class="col-12">
              <label for="address">Delivery Address</label>
              <textarea id="address" placeholder="Street, District, Province, Postal Code" required></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Product Selection -->
      <div class="card">
        <div class="header">
          <i class="fas fa-boxes-stacked"></i>
          Product Selection
        </div>
        <div class="body">
          <div id="productList"></div>
          <div style="margin-top: 1rem;">
            <button type="button" class="btn" id="addProductBtn">
              <i class="fas fa-plus"></i>
              Add Product
            </button>
          </div>
        </div>
      </div>

      <!-- Debug & Errors -->
      <div class="card">
        <div class="body">
          <details class="debug">
            <summary>Show JSON preview (for integration)</summary>
            <pre id="output"></pre>
          </details>
          <div id="formErrors" class="error-box" style="display:none"></div>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        <button type="submit" class="btn primary">
          <i class="fas fa-paper-plane"></i>
          Submit Inquiry
        </button>
      </div>
    </form>
  </div>

  <!-- JavaScript remains unchanged -->
  <script type="application/json" id="product-data">{{DATA_JSON}}</script>
  <script>
  // [Previous JavaScript content remains exactly the same]
  // Date input mask, product logic, form submission - all preserved
  document.addEventListener('DOMContentLoaded', () => {
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    const requestDate = $('#requestDate');
    if (requestDate) {
      requestDate.value = (()=>{ const d=new Date(); const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); return `${dd}/${mm}/${yy}`; })();
      requestDate.addEventListener('input', (e)=>{
        let v = e.target.value.replace(/[^0-9]/g,'');
        if (v.length>=3 && v.length<=4) v = v.slice(0,2)+'/'+v.slice(2);
        if (v.length>=5) v = v.slice(0,2)+'/'+v.slice(2,4)+'/'+v.slice(4,8);
        e.target.value = v.slice(0,10);
      });
    }

    function parseProductJSON(){
      try{
        const el = document.getElementById('product-data');
        if(!el) return [];
        const data = JSON.parse(el.textContent.trim());
        return Array.isArray(data) ? data : [];
      }catch(err){ console.error(err); return []; }
    }

    function buildIndexes(data){
      const groups = new Set();
      const patByG = new Map();
      const colByGP = new Map();
      const sizeByGPC = new Map();
      const borderByG = new Map();
      const mapAll = new Map();
      data.forEach(it=>{
        const g=it.Group?.trim(); const p=it.Pattern?.trim(); const c=it.Color?.trim(); const s=it.Size?.trim();
        if(!g||!p||!c||!s) return;
        groups.add(g);
        if(!patByG.has(g)) patByG.set(g, new Set());
        patByG.get(g).add(p);
        const kGP = `${g}|${p}`;
        if(!colByGP.has(kGP)) colByGP.set(kGP, new Set());
        colByGP.get(kGP).add(c);
        const kGPC = `${g}|${p}|${c}`;
        if(!sizeByGPC.has(kGPC)) sizeByGPC.set(kGPC, new Set());
        sizeByGPC.get(kGPC).add(s);
        if (it.Border) {
          if (!borderByG.has(g)) borderByG.set(g, new Set());
          borderByG.get(g).add(it.Border.trim());
        }
        mapAll.set(`${g}|${p}|${c}|${s}`, it);
      });
      return { groups: Array.from(groups).sort(), patByG, colByGP, sizeByGPC, borderByG, mapAll };
    }

    function makeOption(val, text){ const o=document.createElement('option'); o.value=val??''; o.textContent=text??val??''; return o; }
    function fillSelect(sel, values, ph){
      sel.innerHTML = '';
      sel.appendChild(makeOption('', ph || 'Select'));
      values.forEach(v => sel.appendChild(makeOption(v)));
      if (sel.classList.contains('size')) sel.appendChild(makeOption('__custom__', 'Custom Size'));
      sel.disabled = values.length === 0;
    }

    function extractDriveId(rawUrl) {
      if (!rawUrl) return '';
      try {
        const url = String(rawUrl).replace(/&amp;/g, '&');
        const u = new URL(url, window.location.origin);
        const byQuery = u.searchParams.get('id');
        if (byQuery) return byQuery;
        const m = u.pathname.match(/\/(?:file\/)?d\/([A-Za-z0-9_-]+)/);
        return (m && m[1]) ? m[1] : '';
      } catch {
        const m = String(rawUrl).replace(/&amp;/g, '&').match(/(?:[?&]id=|\/d\/)([A-Za-z0-9_-]+)/);
        return m ? m[1] : '';
      }
    }
    function buildDrivePreviewUrls(id) {
      if (!id) return [];
      return [
        `https://drive.google.com/thumbnail?id=${id}&sz=w800-h600`,
        `https://drive.google.com/uc?export=download&id=${id}`,
        `https://drive.google.com/uc?export=view&id=${id}`
      ];
    }
    function tryImageUrls(urls, cb) {
      if (!urls.length) return cb('');
      const [first, ...rest] = urls;
      const probe = new Image();
      probe.onload  = () => cb(first);
      probe.onerror = () => tryImageUrls(rest, cb);
      probe.referrerPolicy = 'no-referrer';
      probe.src = first;
    }
    function resolveDrivePreviewSrc(rawUrl, cb) {
      const id = extractDriveId(rawUrl);
      if (!id) return cb('');
      tryImageUrls(buildDrivePreviewUrls(id), cb);
    }

    function createProductItem(indexes){
      const wrap = document.createElement('div');
      wrap.className = 'product-item';
      wrap.innerHTML = `
        <div class="remove-wrap">
          <button type="button" class="btn link remove-btn" title="Remove">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        <div class="product-grid">
          <div>
            <div>
              <label>Product Group</label>
              <select class="group" style="width:100%"></select>
            </div>
            <div style="margin-top:10px;">
              <label>Pattern/Spec</label>
              <select class="pattern" disabled style="width:100%"></select>
            </div>
          </div>
          <div>
            <div class="preview-box">
              <span class="preview-text">Preview</span>
              <img class="preview" alt="Preview" style="display:none;"/>
            </div>
          </div>
        </div>
        <div class="row-line" style="margin-top:10px;">
          <div>
            <label>Color</label>
            <select class="color" disabled style="width:100%"></select>
          </div>
          <div>
            <label>Size</label>
            <select class="size" disabled style="width:100%"></select>
            <input type="text" class="custom-size" placeholder="Enter custom size" style="display:none; margin-top:8px;"/>
          </div>
          <div>
            <label>Border</label>
            <select class="border" disabled style="width:100%"></select>
          </div>
          <div>
            <label>Qty</label>
            <input type="number" class="qty" min="1" step="1" value="1" style="width:100%"/>
          </div>
        </div>
        <div style="margin-top:10px;">
          <label>Notes</label>
          <textarea class="notes" placeholder="Any special requests..."></textarea>
        </div>
      `;

      const selG = wrap.querySelector('select.group');
      const selP = wrap.querySelector('select.pattern');
      const selC = wrap.querySelector('select.color');
      const selS = wrap.querySelector('select.size');
      const customSizeInput = wrap.querySelector('.custom-size');
      const img  = wrap.querySelector('img.preview');
      const previewText = wrap.querySelector('.preview-text');
      const selB = wrap.querySelector('select.border');
      img.referrerPolicy = 'no-referrer';

      fillSelect(selG, indexes.groups, 'Select Group');

      function updatePattern(){ const g=selG.value;
        const set=indexes.patByG.get(g)||new Set();
        fillSelect(selP, Array.from(set).sort(), 'Select Pattern');
        fillSelect(selC, [], 'Select Color');
        fillSelect(selS, [], 'Select Size');
        const bset = indexes.borderByG?.get(g) || new Set();
        fillSelect(selB, Array.from(bset).sort(), 'Select Border');
        updatePreview(); }
      function updateColor(){ const g=selG.value; const p=selP.value; const set=indexes.colByGP.get(`${g}|${p}`)||new Set(); fillSelect(selC, Array.from(set).sort(), 'Select Color'); fillSelect(selS, [], 'Select Size'); updatePreview(); }
      function updateSize(){ const g=selG.value; const p=selP.value; const c=selC.value; const set=indexes.sizeByGPC.get(`${g}|${p}|${c}`)||new Set(); fillSelect(selS, Array.from(set).sort(), 'Select Size'); updatePreview(); }

      function updatePreview(){
        const g=selG.value, p=selP.value, c=selC.value, s=selS.value;
        const item = (g && p && c && s) ? indexes.mapAll.get(`${g}|${p}|${c}|${s}`) : null;
        if (item && item.Picture) {
          resolveDrivePreviewSrc(item.Picture, (goodSrc) => {
            if (goodSrc) {
              img.src = goodSrc;
              img.style.display = 'block';
              previewText.style.display = 'none';
            } else {
              img.removeAttribute('src');
              img.style.display = 'none';
              previewText.style.display = 'block';
            }
          });
        } else {
          img.removeAttribute('src');
          img.style.display = 'none';
          previewText.style.display = 'block';
        }
      }

      selG.addEventListener('change', updatePattern);
      selP.addEventListener('change', updateColor);
      selC.addEventListener('change', updateSize);
      selS.addEventListener('change', () => {
        if (selS.value === '__custom__') {
          customSizeInput.style.display = 'block';
        } else {
          customSizeInput.style.display = 'none';
        }
        updatePreview();
      });
      selB.addEventListener('change', updatePreview);

      wrap.querySelector('.remove-btn').addEventListener('click', ()=> wrap.remove());

      return wrap;
    }

    function collectForm(){
      const errs = [];
      const company = $('#company')?.value.trim()||'';
      const date = $('#requestDate')?.value.trim()||'';
      const contact = $('#contactPerson')?.value.trim()||'';
      const email = $('#email')?.value.trim()||'';
      const phone = $('#phone')?.value.trim()||'';
      const address = $('#address')?.value.trim()||'';

      if(!company) errs.push('Company Name is required');
      if(!/^\d{2}\/\d{2}\/\d{4}$/.test(date)) errs.push('Request Date must be dd/mm/yyyy');
      if(!contact) errs.push('Contact Person is required');
      if(!email) errs.push('Email is required');
      if(!phone) errs.push('Phone is required');
      if(!address) errs.push('Delivery Address is required');

      const products=[];
      $$('#productList .product-item').forEach(wrap=>{
        const g = wrap.querySelector('select.group').value;
        const p = wrap.querySelector('select.pattern').value;
        const c = wrap.querySelector('select.color').value;
        const selS = wrap.querySelector('select.size');
        const customSizeInput = wrap.querySelector('.custom-size');
        let s;
        if (selS.value === '__custom__') {
          s = customSizeInput.value.trim() ? 'Custom - ' + customSizeInput.value.trim() : '';
        } else {
          s = selS.value;
        }
        const border = wrap.querySelector('select.border')?.value || '';
        const qty = parseInt(wrap.querySelector('.qty').value||'0', 10);
        const notes = wrap.querySelector('.notes').value.trim();
        const pic = wrap.querySelector('img.preview').getAttribute('src')||'';
        if (g||p||c||s||qty||notes){
          if(!(g&&p&&c&&s)) errs.push('Each product must have Group, Pattern, Color, and Size');
          if(!(qty>0)) errs.push('Qty must be a positive number');
          products.push({ Group:g, Pattern:p, Color:c, Size:s, Border:border, Qty:qty, Notes:notes, Picture:pic });
        }
      });

      if(products.length===0) errs.push('Please add at least one product');

      return { ok:errs.length===0, errors:errs, data:{ customer:{company, requestDate:date, contactPerson:contact, email, phone, address}, products } };
    }

    const data = parseProductJSON();
    const indexes = buildIndexes(data);

    const list = document.getElementById('productList');
    const addBtn = document.getElementById('addProductBtn');

    function addItem(){ const item = createProductItem(indexes); list.appendChild(item); }
    addBtn?.addEventListener('click', addItem);
    addItem();

    const previewBox = document.getElementById('output');
    const errorBox = document.getElementById('formErrors');

    const FLOW_URL = 'https://default8675ca1573af4ed8a69960d610dfe1.bd.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/cb8e8d77efce4b1e936917f671073b47/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=u6FmDNCJX1LbPoO-ooBEUS0Yv120SqhJHF_whwfAK9M';

    document.getElementById('inquiryForm').addEventListener('submit', async (e)=>{
      e.preventDefault();

      const r = collectForm();
      if(!r.ok){
        errorBox.style.display='block';
        errorBox.innerHTML = r.errors.map(x=>'• '+x).join('<br>');
        errorBox.scrollIntoView({behavior:'smooth', block:'center'});
        return;
      }

      previewBox.textContent = JSON.stringify(r.data, null, 2);

      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn?.textContent;
      if (submitBtn){ submitBtn.disabled = true; submitBtn.textContent = 'Submitting…'; }

      try {
        const res = await fetch(FLOW_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(r.data)
        });

        if (!res.ok) {
          const t = await res.text().catch(()=> '');
          throw new Error(t || `HTTP ${res.status}`);
        }

        errorBox.style.display = 'none';
        alert('Submitted! Your inquiry has been sent.');
        e.target.reset();
        if (requestDate) {
          const d = new Date();
          requestDate.value = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
        }
        list.innerHTML = '';
        addItem();

      } catch (err) {
        errorBox.style.display = 'block';
        errorBox.textContent = `Submit failed: ${String(err.message || err)}`;
        errorBox.scrollIntoView({behavior:'smooth', block:'center'});
      } finally {
        if (submitBtn){ submitBtn.disabled = false; submitBtn.textContent = originalText || 'Submit Inquiry'; }
      }
    });
  });
  </script>
</body>
</html>